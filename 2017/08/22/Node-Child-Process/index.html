<!DOCTYPE html>
<html  lang="en">

<head>
    <meta charset="utf-8">
<title>Node Child Process - EzCook</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />







<link rel="icon" href="/images/logo.png">

<link href="https://fonts.googleapis.com/css?family=Averia+Serif+Libre|DM+Serif+Text&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">




    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    



    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">







<link rel="stylesheet" href="/css/back-to-top.css">




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-136207372-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-136207372-1');
</script>




<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>



    



    
        <script async="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    




<link rel="stylesheet" href="/css/style.css">

</head>

<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/logo.png" alt="Node Child Process" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">Home</a>
                
                <a class="navbar-item"
                href="/archives">Archives</a>
                
                <a class="navbar-item"
                href="/projects">Projects</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    
                    <a class="navbar-item" target="_blank" title="GitHub" href="https://github.com/keith-CY">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                    <a class="navbar-item" target="_blank" title="Gmail" href="mailto:keithwhisper@gmail.com">
                        
                        <i class="fas fa-envelope"></i>
                        
                    </a>
                    
                
                
                
                <a class="navbar-item search" title="Search" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>

    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2017-08-22T06:51:20.000Z">2017-08-22</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    17 minutes read (About 2552 words)
                </span>
                
                
                <span class="level-item has-text-grey" id="busuanzi_container_page_pv">
                    <i class="far fa-eye"></i>
                    <span id="busuanzi_value_page_pv">0</span> visits
                </span>
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                Node Child Process
            
        </h1>
        <div class="content">
            <p><img src="https://cdn-images-1.medium.com/max/2000/1*I56pPhzO1VQw8SIsv8wYNA.png" alt=""></p>
<p>Single-threaded, non-blocking performance in Node works great for a single process. But eventually, one process in one CPU is not going to be enough to handle the increasing workload of your application.</p>
<p>Using multiple processes is the best way to scale a Node application. Node is designed for building distributed applications with many nodes.</p>
<h3 id="The-Child-Process-Module"><a href="#The-Child-Process-Module" class="headerlink" title="The Child Process Module"></a>The Child Process Module</h3><p>We can easily spin a child process using Node’s <code>child_process</code> module and those child processes can easily communicate with each other with a messaging system.</p>
<p>The <code>child_process</code> module enables us to access Operating System functionalities by running any system command inside child process.</p>
<p>We can control that child process input stream, and listen to its output stream. We can also control the arguments to be passed to the underlying OS command, and we can do whatever we want with that command’s output.</p>
<p>There are four different ways to create a child process in Node: <code>spawn()</code>, <code>fork()</code>, <code>exec()</code>, <code>execFile()</code>.</p>
<h3 id="Spawned-Child-Process"><a href="#Spawned-Child-Process" class="headerlink" title="Spawned Child Process"></a>Spawned Child Process</h3><p>The <code>spawn</code> function launches a command in a new process and we can use it to pass that command any arguments. For example, here’s code to spawn a new process that will execute the <code>pwd</code> command.</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="hljs-keyword">const</span> &#123; spawn &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>)</div><div class="line"></div><div class="line"><span class="hljs-keyword">const</span> child = spawn(<span class="hljs-string">'pwd'</span>)</div></pre></td></tr></table></figure>
<p>We simply destructure the <code>spawn</code> function out of the <code>child_process</code> module and execute it with the OS command as the first argument.</p>
<p>The result of executing the <code>spawn</code> function (the <code>child</code> object above) is a <code>ChildProcess</code> instance, which implements the <code>EventEmitter API</code>. This means we can register handlers for events on this child object directly. For example, we can do something when the child process exits by registering a handler for the <code>exit</code> event.</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">child.on(<span class="hljs-string">'exit'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">code, signal</span>) </span>&#123;</div><div class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'child process exited with '</span> + <span class="hljs-string">`code <span class="hljs-subst">$&#123;code&#125;</span> and signal <span class="hljs-subst">$&#123;signal&#125;</span>`</span>)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>The handler above gives us the exit <code>code</code> for the child process and the <code>signal</code>, if any, that was used to terminate the child process. This <code>signal</code> variable is null when the child process exits normally.</p>
<p>The other events that we can register handlers for with the <code>ChildProcess</code> instances are <code>disconnect</code>, <code>error</code>, <code>close</code>, <code>message</code>.</p>
<ul>
<li><p>The <code>disconnect</code> event is emitted when the parent process manually calls the <code>child.disconnect</code> function.</p>
</li>
<li><p>The <code>error</code> event is emitted if the process could not be spawned or killed.</p>
</li>
<li><p>The <code>close</code> event is emitted when the <code>stdio</code> streams of a child process get closed.</p>
</li>
<li><p>The <code>message</code> event is the most important one. It’s emitted when the child process uses the <code>process.send()</code> function to send messages. This is how parent/child processes can communicate with each other.</p>
</li>
</ul>
<p>Every child process also gets the three standard <code>stdio</code> streams, which we can access using <code>child.stdin</code>, <code>child.stdout</code>, <code>child.stderr</code>.</p>
<p>When those streams get closed, the child process that was using them will emit the <code>close</code> event. This <code>close</code> event is different than the <code>exit</code> event because multiple child processes might share the same <code>stdio</code> streams and so one child process exiting does not mean that the streams got closed.</p>
<p>Since all streams are event emitters, we can listen to different events on those <code>stdio</code> stream that are attached to every child process. Unlike in a normal process though, in a child process, the <code>stdout</code>/<code>stderr</code> streams are readable streams while the <code>stdin</code> stream is a writable one. This is basically the inverse of those types as found in a main process. The events we can use for those streams are the standard ones. Most importantly, on the readable streams, we can listen to the <code>data</code> event, which will have the output of the command or any errorencoutered while executing the command:</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">child.stdout.on(<span class="hljs-string">'data'</span>, (data) =&gt; &#123;</div><div class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`child stdout:\n<span class="hljs-subst">$&#123;data&#125;</span>`</span>)</div><div class="line">&#125;)</div><div class="line"></div><div class="line">child.stderr.on(<span class="hljs-string">'data'</span>, (data) =&gt; &#123;</div><div class="line">  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`child \n<span class="hljs-subst">$&#123;data&#125;</span>`</span>)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>The two handlers above will log both cases to the main process <code>stdout</code> and <code>stderr</code>. When we execute the <code>spawn</code> function above, the output of the <code>pwd</code> command gets printed and the child process exits with code <code>0</code>, which means no error occured.</p>
<p>We can pass arguments to the command that’s executed by the <code>spawn</code> function using the second argument of the <code>spawn</code> function, which is an array of all the arguments to be passed to the command.</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="hljs-keyword">const</span> child = spawn(<span class="hljs-string">'find'</span>, [<span class="hljs-string">'.'</span>, <span class="hljs-string">'-type'</span>, <span class="hljs-string">'f'</span>])</div></pre></td></tr></table></figure>
<p>If an error occurs during the execution of the command, for example, if we give find an invalid destination above, the <code>child.stderr</code> <code>data</code> event handler will be triggered and the <code>exit</code> event handler will report an exit code of <code>1</code>, which signifies that an error has occured.</p>
<p>A child process <code>stdin</code> is a writable stream. We can use it to send a command some input. Just like any writable stream, the easiest way to consume it is using the <code>pipe</code> function. We simply pipe a readable stream into a writable stream. SInce the main process <code>stdin</code> is a readable stream, we can pipe that into a child process <code>stdin</code> stream.</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="hljs-keyword">const</span> &#123; spawn &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>)</div><div class="line"></div><div class="line"><span class="hljs-keyword">const</span> child = spawn(<span class="hljs-string">'wc'</span>)</div><div class="line"></div><div class="line">process.stdin.pipe(child.stdin)</div><div class="line"></div><div class="line">child.stdout.on(<span class="hljs-string">'data'</span>, (data) =&gt; &#123;</div><div class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`child stdout:\n<span class="hljs-subst">$&#123;data&#125;</span>`</span>)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>In the example above, the child process invokes the <code>wc</code> command, which count lines, words, and characters in Linux. When we pipe the main process <code>stdin</code>(which is a readable stream) into the child process <code>stdin</code>(which is a writable stream). The result of this combination is that we get a standard input mode where we can type somthing and when we hit <code>Ctrl + D</code>, what we typed will be used as the input of the <code>wc</code> command.</p>
<p>We can also pipe the standard input/output of multiple processes on each other, just like we can do with Linux commands. For example, we can pipe the <code>stdout</code> of the <code>find</code> command to the <code>stdin</code> of the <code>wc</code> command to count all the files in the current directory:</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="hljs-keyword">const</span> &#123; spawn &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>)</div><div class="line"></div><div class="line"><span class="hljs-keyword">const</span> find = spawn(<span class="hljs-string">'find'</span>, [<span class="hljs-string">'.'</span>, <span class="hljs-string">'-type'</span>, <span class="hljs-string">'f'</span>])</div><div class="line"><span class="hljs-keyword">const</span> wc = spawn(<span class="hljs-string">'wc'</span>, [<span class="hljs-string">'-l'</span>])</div><div class="line"></div><div class="line">find.stdout.pipe(wc.stdin)</div><div class="line"></div><div class="line">wc.stdout.on(<span class="hljs-string">'data'</span>, (data) =&gt; &#123;</div><div class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Number of files <span class="hljs-subst">$&#123;data&#125;</span>`</span>)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>Add <code>-l</code> to the <code>wc</code> command to make it count only the lines.</p>
<h3 id="Shell-Syntax-and-the-exec-Function"><a href="#Shell-Syntax-and-the-exec-Function" class="headerlink" title="Shell Syntax and the exec Function"></a>Shell Syntax and the exec Function</h3><p>By default, the <code>spawn</code> function does not create a <em>shell</em> to execute the command we pass into it. This makes it slightly more efficient than the <code>exec</code> function, which does create a shell. The <code>exec</code> function has one other major difference. It <em>buffers</em> the command’s generated output and passes the whole output value to a callback function(instead of using streams, which is what <code>spawn</code> does).</p>
<p>Here the is previous <code>find | wc</code> example implemented with an <code>exec</code> function.</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="hljs-keyword">const</span> &#123; exec &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>)</div><div class="line"></div><div class="line">exec(<span class="hljs-string">'find . -type  f | wc -l'</span>, (err, stdout, stderr) =&gt; &#123;</div><div class="line">  <span class="hljs-keyword">if</span> (err) &#123;</div><div class="line">    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`exec error: <span class="hljs-subst">$&#123;err&#125;</span>`</span>)</div><div class="line">    <span class="hljs-keyword">return</span></div><div class="line">  &#125;</div><div class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Number of files <span class="hljs-subst">$&#123;stdout&#125;</span>`</span>)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>Since the <code>exec</code> function uses a shell to execute the command, we can use the <code>shell syntax</code> directly here making use of the <code>shell pipe</code> feature.</p>
<p>Note that using the shell syntax comes at a <code>security risk</code> if you’re executing any kind of dynamic input provided externally. A user can simply do a command injection attrack using shell syntax characters like ; and $(For example, <code>commnd + &#39;; rm -rf ~&#39;</code>)</p>
<p>The <code>exec</code> function buffers the output and passes it to the callback function(the second argument to <code>exec</code>) as the <code>stdout</code> argument there. This <code>stdout</code> argument is the command’s output that we want to print out.</p>
<p>The <code>exec</code> function is a good choice if you need to use the shell syntax and if the size of the data expected from te command is small(Remember <code>exec</code> will buffer the whole data in memory before returning it).</p>
<p>The <code>spawn</code> function is a much better choice when the size of the data expected from the command is large, because that data will be streamed with the standard IO objects.</p>
<p>We can make the spawned child process inherit the standard IO object of its parents if we want to, but also, more importantly, we can ke the <code>spawn</code> function use the shell syntax as well. Here’s the smae <code>find | wc</code> command implemented with the <code>spawn</code>.</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="hljs-keyword">const</span> child = spawn(<span class="hljs-string">'find . -type f'</span>, &#123;</div><div class="line">  <span class="hljs-attr">stdio</span>: <span class="hljs-string">'inherit'</span>,</div><div class="line">  <span class="hljs-attr">shell</span>: <span class="hljs-literal">true</span>,</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>Because of the <code>stdio: &#39;inherit&#39;</code> option above, when we execute the code, the child process inherits the main process <code>stdin</code>, <code>stdout</code> and <code>stderr</code>. This causes the child process data events handlers to be triggered on the main <code>process.stdout</code> stream, making the script output the result right away.</p>
<p>Because of the <code>shell: true</code> option above, we were able to use the shell syntax in the passed command, just like we did with <code>exec</code>. But with this code, we still get the advantage of the streaming of data that the <code>spawn</code> function gives us. <em>THis is really the best of both worlds</em>.</p>
<p>There are a few other good options we can use in the last argument to the <code>child_process</code> function besides <code>shell</code> and <code>stdio</code>. We can, for example, use the <code>cwd</code> option to change the working directory of the script.</p>
<p>Another option we can use is the <code>env</code> option to specify the environment variables that will be visible to the new child process. The default for this option is <code>process.env</code> which gives any command access to the current process environment. If we want ot override that behavior, we can simple pass an empty object as the <code>env</code> option or new value there to be considered as the only environment variables:</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="hljs-keyword">const</span> child = spawn(<span class="hljs-string">'echo $ANSWER'</span>, &#123;</div><div class="line">  <span class="hljs-attr">stdio</span>: <span class="hljs-string">'inherit'</span>,</div><div class="line">  <span class="hljs-attr">shell</span>: <span class="hljs-literal">true</span>,</div><div class="line">  <span class="hljs-attr">env</span>: &#123;</div><div class="line">    <span class="hljs-attr">ANSWER</span>: <span class="hljs-number">12</span>,</div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>The echo command above does not have access to the parent process’s environment variables. It can’t, for example, access <code>$HOME</code>, but it can accccess <code>$ANSWER</code> because it was passes as a custom environement variable through the <code>env</code> option.</p>
<p>One last important child process option to explain here is the <code>detached</code> option, which makes the child process run independently of its parent process.</p>
<p>Assuming we have a file <code>timer.js</code> that keeps the event loop busy:</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</div><div class="line">  <span class="hljs-comment">// keep the event loop busy</span></div><div class="line">&#125;, <span class="hljs-number">20000</span>)</div></pre></td></tr></table></figure>
<p>We can execute it in the background using the <code>detached</code> option:</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="hljs-keyword">const</span> &#123; spawn &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>)</div><div class="line"></div><div class="line"><span class="hljs-keyword">const</span> child = spawn(<span class="hljs-string">'node'</span>, [<span class="hljs-string">'timer.js'</span>], &#123;</div><div class="line">  <span class="hljs-attr">detached</span>: <span class="hljs-literal">true</span>,</div><div class="line">  <span class="hljs-attr">stdio</span>: <span class="hljs-string">'ignore'</span>,</div><div class="line">&#125;)</div><div class="line"></div><div class="line">child.unref()</div></pre></td></tr></table></figure>
<p>The exact behavior of detached child process depends on the OS. On windows, the detached child process will have its own console window while on Linux the detached child process will be made the leader of a new process groups and session.</p>
<p>It the <code>unref</code> function is called on the detached process, the parent process can exit independently of the child. This can be useful if the child is executing a long-running process, but to keep it running in the background the child’s <code>stdio</code> configurations also have to be independent of the parent.</p>
<p>The example above will run a node script(timer.js) in the background by detaching and also ignoring its parent <code>stdio</code> file descriptors so that the parent can terminate while the child keeps running in the background.</p>
<h3 id="The-execFile-function"><a href="#The-execFile-function" class="headerlink" title="The execFile function"></a>The execFile function</h3><p>If you need to execute a file without using a shell, the <code>execFile</code> function is what you need. It behaves exactly like the <code>exec</code> function, but does not use a shell, which makes it a bit more efficient. On windows, some files cannot be executed on their own, like <code>.bat</code>, <code>.cmd</code> files. Those files cannot be executed with <code>execFile</code> and either <code>exec</code> or <code>spawn</code> with shell set to true is required to execute them.</p>
<h3 id="The-Sync-Function"><a href="#The-Sync-Function" class="headerlink" title="The *Sync Function"></a>The *Sync Function</h3><p>The functions <code>spawn</code>, <code>exec</code>, <code>execFile</code> from the <code>child_process</code> module also have synchronous blocking versions that will wait until child process exits.</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="hljs-keyword">const</span> &#123;</div><div class="line">  spawnSync,</div><div class="line">  execSync,</div><div class="line">  execFileSync,</div><div class="line">&#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>)</div></pre></td></tr></table></figure>
<h3 id="The-fork-function"><a href="#The-fork-function" class="headerlink" title="The fork() function"></a>The fork() function</h3><p>THe <code>fork</code> function is a variation of the <code>spawn</code> function for spawning node processes. The biggest difference between <code>spawn</code> and <code>fork</code> is that a communication channel is established to the child process when using <code>fork</code>, so we can use the <code>send</code> function on the forked along with the global <code>process</code> object itself to exchange messsages between the parent and forked processes. We do this through the <code>EventEmitter</code> module interface.</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="hljs-comment">// parent.js</span></div><div class="line"><span class="hljs-keyword">const</span> &#123; fork &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>)</div><div class="line"></div><div class="line"><span class="hljs-keyword">const</span> forked = fork(<span class="hljs-string">'child.js'</span>)</div><div class="line"></div><div class="line">forked.on(<span class="hljs-string">'message'</span>, (msg) =&gt; &#123;</div><div class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Message from child'</span>, msg)</div><div class="line">&#125;)</div><div class="line"></div><div class="line">forked.send(&#123;</div><div class="line">  <span class="hljs-attr">hello</span>: <span class="hljs-string">'world'</span>,</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="hljs-comment">// child.js</span></div><div class="line"></div><div class="line">process.on(<span class="hljs-string">'message'</span>, (msg) =&gt; &#123;</div><div class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Message from parent:'</span>, msg)</div><div class="line">&#125;)</div><div class="line"><span class="hljs-keyword">let</span> counter = <span class="hljs-number">0</span></div><div class="line"></div><div class="line">setInterval(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</div><div class="line">  process.send(&#123;</div><div class="line">    <span class="hljs-attr">counter</span>: counter++</div><div class="line">  &#125;)</div><div class="line">&#125;, <span class="hljs-number">1000</span>)</div></pre></td></tr></table></figure>
<p>In the parent.js we fork <code>child.js</code>(<strong>which will execute the file with the <code>node</code> command</strong>) and then we listen for the <code>message</code> event. The <code>message</code> event will be emitted whenever the child use <code>process.send</code>.</p>
<p>The pass down messages from the parent to the child, we can execute the <code>send</code> function one the forked object it self, and then, in the child script we can listen to the <code>message</code> event on the global <code>process</code>.</p>
<p>When executing the <code>parent.js</code> file, it’ll first send down the <code>{hello: &#39;world&#39;}</code> object to be printed by the forked child process and then the forked child process will send an incremental counter value every second to be printed by the parent process.</p>
<p>Let’s do more practical example about the <code>fork</code> function.</p>
<p>Let’s say we have an http server that handles two endpoints. One of these endpoints(<code>/compute</code> below) is computationally expensive and will take a few seconds to complete. WE can use a long for loop to simulate that:</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>)</div><div class="line"></div><div class="line"><span class="hljs-keyword">const</span> longComputation = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</div><div class="line">  <span class="hljs-keyword">let</span> sum = <span class="hljs-number">0</span></div><div class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1e9</span>; i++) &#123;</div><div class="line">    sum += i</div><div class="line">  &#125;</div><div class="line">  <span class="hljs-keyword">return</span> sum</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="hljs-keyword">const</span> server = http.createServer()</div><div class="line"></div><div class="line">server.on(<span class="hljs-string">'request'</span>, (req, res) =&gt; &#123;</div><div class="line">  <span class="hljs-keyword">if</span> (req.url === <span class="hljs-string">'/compute'</span>) &#123;</div><div class="line">    <span class="hljs-keyword">const</span> sum = longComputation()</div><div class="line">    <span class="hljs-keyword">return</span> res.end(<span class="hljs-string">`Sum is <span class="hljs-subst">$&#123;sum&#125;</span>`</span>)</div><div class="line">  &#125; <span class="hljs-keyword">else</span> &#123;</div><div class="line">    res.end(<span class="hljs-string">'OK'</span>)</div><div class="line">  &#125;</div><div class="line">&#125;)</div><div class="line"></div><div class="line">server.listen(<span class="hljs-number">3000</span>)</div></pre></td></tr></table></figure>
<p>The program has a big problem: when the <code>/compute</code> endpoint is requested, the server will not be able to handle any other requests because the event loop is busy with the long for loop operation.</p>
<p>There are a few ways which we can solve this problem depending on the nature of the long operation but one solution that works for all operation is to just move the computational operation into another process using <code>fork</code>.</p>
<p>We first move the whole <code>longComputation</code> function into its own file and make it invoke that function when instructed via a message from the main process:</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="hljs-comment">// compute.js</span></div><div class="line"></div><div class="line"><span class="hljs-keyword">const</span> longComputatioin  = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</div><div class="line">  <span class="hljs-keyword">let</span> sum = <span class="hljs-number">0</span></div><div class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1e9</span>; i++) &#123;</div><div class="line">    sum += i;</div><div class="line">  &#125;</div><div class="line">  <span class="hljs-keyword">return</span> sum</div><div class="line">&#125;</div><div class="line"></div><div class="line">process.on(<span class="hljs-string">'message'</span>, (msg) =&gt; &#123;</div><div class="line">  <span class="hljs-keyword">const</span> sum = longComputatioin()</div><div class="line">  process.send(sum)</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="hljs-comment">// server.js</span></div><div class="line"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>)</div><div class="line"><span class="hljs-keyword">const</span> &#123; fork &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>)</div><div class="line"></div><div class="line"><span class="hljs-keyword">const</span> server = http.createServer()</div><div class="line"></div><div class="line">server.on(<span class="hljs-string">'request'</span>, (req, res) =&gt; &#123;</div><div class="line">  <span class="hljs-keyword">if</span> (req.url === <span class="hljs-string">'/compute'</span>) &#123;</div><div class="line">    <span class="hljs-keyword">const</span> compute = fork(<span class="hljs-string">'compute.js'</span>)</div><div class="line">    compute.send(<span class="hljs-string">'start'</span>)</div><div class="line">    compute.on(<span class="hljs-string">'message'</span>, sum =&gt; &#123;</div><div class="line">      res.end(<span class="hljs-string">`Sum is <span class="hljs-subst">$&#123;sum&#125;</span>`</span>)</div><div class="line">    &#125;)</div><div class="line">  &#125; <span class="hljs-keyword">else</span> &#123;</div><div class="line">    res.end(<span class="hljs-string">'OK'</span>)</div><div class="line">  &#125;</div><div class="line">&#125;)</div><div class="line"></div><div class="line">server.listen(<span class="hljs-number">3000</span>)</div></pre></td></tr></table></figure>
<p>When a request to <code>/compute</code> happens now with the above code, we simply send a message to the forked process to start executing the long operation. The main process’s event loop will not be blocked.</p>
<p>Once the forked process is done with the long operation, it can send its result back to the parent process using <code>process.send</code>.</p>
<p>Node’s <code>cluster</code> module is based on this idea of child process forking and load balancing the requests among the many forks.</p>

        </div>
        
        
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="menu-label has-text-centered">Like this article? Support the author with</h3>
        <div class="buttons is-centered">
            
                <!-- Visit https://www.paypal.com/donate/buttons/ to get your donate button -->

<a class="button is-warning donate" onclick="document.getElementById(&#39;paypal-donate-form&#39;).submit()">
    <span class="icon is-small">
        <i class="fab fa-paypal"></i>
    </span>
    <span>Paypal</span>
</a>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank" id="paypal-donate-form">
    <input type="hidden" name="cmd" value="_donations" />
    <input type="hidden" name="business" value="chen.yu.keith@foxmail.com" />
    <input type="hidden" name="currency_code" value="USD" />
</form>

                
        </div>
    </div>
</div>



<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/2017/08/24/Node-js-child-process/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">Node.js Child_process</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/2017/08/22/Scaling-Node-js-App/">
                <span class="level-item">Scaling Node.js App</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="title is-5 has-text-weight-normal">Comments</h3>
        
<div id="comment-container"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
	var gitment = new Gitment({
		id: '2017/08/22/Node-Child-Process/',
		owner: 'Keith-CY',
		repo: 'Keith-CY.github.io',
		oauth: {
			client_id: '56319e1ce36ed4313555',
			client_secret: 'ca7f10a8357d52290f5509fb54e5173a8bea0a5d',
		},
	})
	gitment.render('comment-container')
</script>

    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("en");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="Back to Top" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    

    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>

</html>
