<!DOCTYPE html>
<html  lang="en">

<head>
    <meta charset="utf-8">
<title>Association in Phoenix - EzCook</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />







<link rel="icon" href="/images/logo.png">

<link href="https://fonts.googleapis.com/css?family=Averia+Serif+Libre|DM+Serif+Text&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">




    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    



    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">







<link rel="stylesheet" href="/css/back-to-top.css">




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-136207372-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-136207372-1');
</script>




<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>



    



    
        <script async="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    




<link rel="stylesheet" href="/css/style.css">
<script data-ad-client="ca-pub-8896169856986797" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/logo.png" alt="Association in Phoenix" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">Home</a>
                
                <a class="navbar-item"
                href="/archives">Archives</a>
                
                <a class="navbar-item"
                href="/projects">Projects</a>
                
                <a class="navbar-item"
                href="https://wiki.digit-map.de/">Digit Map</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    
                    <a class="navbar-item" target="_blank" title="GitHub" href="https://github.com/keith-CY">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                    <a class="navbar-item" target="_blank" title="Gmail" href="mailto:keithwhisper@gmail.com">
                        
                        <i class="fas fa-envelope"></i>
                        
                    </a>
                    
                
                
                
                <a class="navbar-item search" title="Search" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>

    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2018-05-15T07:06:06.000Z">2018-05-15</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    4 minutes read (About 527 words)
                </span>
                
                
                <span class="level-item has-text-grey" id="busuanzi_container_page_pv">
                    <i class="far fa-eye"></i>
                    <span id="busuanzi_value_page_pv">0</span> visits
                </span>
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                Association in Phoenix
            
        </h1>
        <div class="content">
            <p><a href="http://blog.plataformatec.com.br/2015/08/working-with-ecto-associations-and-embeds/" target="_blank" rel="noopener">Original</a></p>
<h3 id="Associations"><a href="#Associations" class="headerlink" title="Associations"></a>Associations</h3><p>Associations in Ecto are used when two difference sources(tables) are linked via foreign keys.</p>
<p>A classic example of this setup is “Post has many comments”. First create the two tables in migrations</p>
<figure class="highlight elixir hljs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">create table(<span class="hljs-symbol">:posts</span>) <span class="hljs-keyword">do</span></div><div class="line">  add <span class="hljs-symbol">:title</span>, <span class="hljs-symbol">:string</span></div><div class="line">  add <span class="hljs-symbol">:body</span>, <span class="hljs-symbol">:text</span></div><div class="line"></div><div class="line">  timestamps()</div><div class="line"><span class="hljs-keyword">end</span></div><div class="line"></div><div class="line">create table(<span class="hljs-symbol">:comments</span>) <span class="hljs-keyword">do</span></div><div class="line">  add <span class="hljs-symbol">:post_id</span>, references(<span class="hljs-symbol">:posts</span>)</div><div class="line">  add <span class="hljs-symbol">:body</span>, <span class="hljs-symbol">:text</span></div><div class="line"></div><div class="line">  timestamps()</div><div class="line"><span class="hljs-keyword">end</span></div></pre></td></tr></table></figure>
<p>Each comment contains a <code>post_id</code> column that by default points to a post <code>id</code></p>
<p>And now defined the schemas</p>
<figure class="highlight elixir hljs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">MyApp</span></span>.Post <span class="hljs-keyword">do</span></div><div class="line">  <span class="hljs-keyword">use</span> Ecto.Schema</div><div class="line"></div><div class="line">  schema <span class="hljs-string">"posts"</span> <span class="hljs-keyword">do</span></div><div class="line">    field <span class="hljs-symbol">:title</span></div><div class="line">    field <span class="hljs-symbol">:body</span></div><div class="line">    has_many <span class="hljs-symbol">:comments</span>, MyApp.Comment</div><div class="line">    timestamps</div><div class="line">  <span class="hljs-keyword">end</span></div><div class="line"><span class="hljs-keyword">end</span></div><div class="line"></div><div class="line"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">MyApp</span></span>.Comment <span class="hljs-keyword">do</span></div><div class="line">  <span class="hljs-keyword">use</span> Ecto.Schema</div><div class="line"></div><div class="line">  schema <span class="hljs-string">"comments"</span> <span class="hljs-keyword">do</span></div><div class="line">    field <span class="hljs-symbol">:body</span></div><div class="line">    belongs_to <span class="hljs-symbol">:post</span>, MyApp.Post</div><div class="line">    timestamps</div><div class="line">  <span class="hljs-keyword">end</span></div><div class="line"><span class="hljs-keyword">end</span></div></pre></td></tr></table></figure>
<h3 id="Querying-associations"><a href="#Querying-associations" class="headerlink" title="Querying associations"></a>Querying associations</h3><p>One of the benefits of defining associations is taht they can be used in queries. For example:</p>
<figure class="highlight elixir hljs"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Repo.all from p <span class="hljs-keyword">in</span> Post, <span class="hljs-symbol">preload:</span> [<span class="hljs-symbol">:comments</span>]</div></pre></td></tr></table></figure>
<p>Now all posts will be fetched from the database with their associated comments. The example above will perform two queries: one for loading all posts and another for loading all comments. This is often the most efficient way of loading associations from the database(even if two queries are performed) because we need to receive and parse only POSTS + COMMENTS results.</p>
<p>It is also possible to preload associations using joins while performing more complex queries. For example, imagine both posts and comments have votes and you want only comments with more votes than the post itself:</p>
<figure class="highlight elixir hljs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Repo.all from p <span class="hljs-keyword">in</span> Post,</div><div class="line">      <span class="hljs-symbol">join:</span> c <span class="hljs-keyword">in</span> assoc(p, <span class="hljs-symbol">:comments</span>),</div><div class="line">      <span class="hljs-symbol">where:</span> c.votes &gt; p.votes</div><div class="line">      <span class="hljs-symbol">preload:</span> [<span class="hljs-symbol">comments:</span> c]</div></pre></td></tr></table></figure>
<h3 id="Manipulating-associations"><a href="#Manipulating-associations" class="headerlink" title="Manipulating associations"></a>Manipulating associations</h3><p>While Ecto 2.0 allows you insert a post with multiple comments in one operation:</p>
<figure class="highlight elixir hljs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Repo.insert!(%Post&#123;</div><div class="line">  <span class="hljs-symbol">title:</span> <span class="hljs-string">"Hello"</span>,</div><div class="line">  <span class="hljs-symbol">body:</span> <span class="hljs-string">"world"</span>,</div><div class="line">  <span class="hljs-symbol">comments:</span> [</div><div class="line">    %Comment&#123;<span class="hljs-symbol">body:</span> <span class="hljs-string">"Excellent"</span>&#125;</div><div class="line">  ]</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>Many times you may want to break it into distinct steps so you have more flexibility in managing those entries. For example, you could use changesets to build your posts and comments along the way</p>
<figure class="highlight elixir hljs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">post = Ecto.Changeset.change(%Post&#123;&#125;, <span class="hljs-symbol">title:</span> <span class="hljs-string">"Hello"</span>, <span class="hljs-symbol">body:</span> <span class="hljs-string">"World"</span>)</div><div class="line">comment = Ecto.Changeset.change(%Comment&#123;&#125;, <span class="hljs-symbol">body:</span> <span class="hljs-string">"Excellent"</span>)</div><div class="line">post_with_comments = Ecto.Changeset.put_assoc(post, <span class="hljs-symbol">:comments</span>, [comment]) <span class="hljs-comment"># Main Step</span></div><div class="line">Repo.insert!(post_with_comments)</div></pre></td></tr></table></figure>
<p>Or by handling each entry individually inside a transation:</p>
<figure class="highlight elixir hljs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Repo.transaction <span class="hljs-keyword">fn</span> -&gt;</div><div class="line">  post = Repo.insert!(%Post&#123;<span class="hljs-symbol">title:</span> <span class="hljs-string">"Hello"</span>, <span class="hljs-symbol">body:</span> <span class="hljs-string">"World"</span>&#125;)</div><div class="line">  <span class="hljs-comment"># Build a comment from the post struct</span></div><div class="line">  comment = Ecto.build_assoc(post, <span class="hljs-symbol">:comments</span>, <span class="hljs-symbol">body:</span> <span class="hljs-string">"Execellent"</span>)</div><div class="line">  Repo.insert!(comment)</div><div class="line"><span class="hljs-keyword">end</span></div></pre></td></tr></table></figure>
<p><code>Ecto.build_assoc/3</code> builds the comment using the id currently set in the post struct. It is equivalnet to:</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">%Comment&#123;post_id: post.id, body: &quot;Execellent&quot;&#125;</div></pre></td></tr></table></figure>
<p>The Ecto.build_assoc/3 function is specially useful in Phoenix controllers. For example when creating the post, one would do:</p>
<figure class="highlight elixir hljs"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Ecto.build_assoc(current_user, <span class="hljs-symbol">:post</span>)</div></pre></td></tr></table></figure>
<p>As we likely want to associate the post to the user currently signed in the application. In another controller, we could build a comment for an existing post with:</p>
<figure class="highlight elixir hljs"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Ecto.build_assoc(post, <span class="hljs-symbol">:comments</span>)</div></pre></td></tr></table></figure>
<p>Ecto does not provide functions like <code>post.comments &lt;&lt; comment</code> that allows mixing persisted data with non-persisted data. The only macha</p>

        </div>
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link" href="/tags/Phoenix-Elixir-Ecto/">Phoenix, Elixir, Ecto</a>
                </div>
            </div>
        </div>
        
        
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="menu-label has-text-centered">Like this article? Support the author with</h3>
        <div class="buttons is-centered">
            
                <!-- Visit https://www.paypal.com/donate/buttons/ to get your donate button -->

<a class="button is-warning donate" onclick="document.getElementById(&#39;paypal-donate-form&#39;).submit()">
    <span class="icon is-small">
        <i class="fab fa-paypal"></i>
    </span>
    <span>Paypal</span>
</a>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank" id="paypal-donate-form">
    <input type="hidden" name="cmd" value="_donations" />
    <input type="hidden" name="business" value="chen.yu.keith@foxmail.com" />
    <input type="hidden" name="currency_code" value="USD" />
</form>

                
        </div>
    </div>
</div>



<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/2018/05/16/GenServer-in-Erlang/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">GenServer in Erlang</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/2018/05/15/cast-assoc/">
                <span class="level-item">Difference Bwtween Build_assoc, Put_assoc, and Cast_assoc</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="title is-5 has-text-weight-normal">Comments</h3>
        
<div id="comment-container"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
	var gitment = new Gitment({
		id: '2018/05/15/Association-in-Phoenix/',
		owner: 'Keith-CY',
		repo: 'Keith-CY.github.io',
		oauth: {
			client_id: '56319e1ce36ed4313555',
			client_secret: 'ca7f10a8357d52290f5509fb54e5173a8bea0a5d',
		},
	})
	gitment.render('comment-container')
</script>

    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("en");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="Back to Top" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    

    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>

</html>
