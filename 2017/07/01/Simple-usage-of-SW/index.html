<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  <title>Simple usage of SW | EzCook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Register123456navigator.serviceWorker.register(&apos;your_service_worker,js&apos;, &amp;#123; scope: &apos;your_path_name&apos; &amp;#125;).then((worker) =&amp;gt; &amp;#123;  console.log(&apos;[SW] Registration succeeded.&apos;)&amp;#125;).catch((er">
<meta property="og:type" content="article">
<meta property="og:title" content="Simple usage of SW">
<meta property="og:url" content="http://yoursite.com/2017/07/01/Simple-usage-of-SW/index.html">
<meta property="og:site_name" content="EzCook">
<meta property="og:description" content="Register123456navigator.serviceWorker.register(&apos;your_service_worker,js&apos;, &amp;#123; scope: &apos;your_path_name&apos; &amp;#125;).then((worker) =&amp;gt; &amp;#123;  console.log(&apos;[SW] Registration succeeded.&apos;)&amp;#125;).catch((er">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://foio.github.io/images/sw-lifecycle.png">
<meta property="og:image" content="http://foio.github.io/images/sw-cache-storage.png">
<meta property="og:updated_time" content="2017-07-04T01:19:52.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Simple usage of SW">
<meta name="twitter:description" content="Register123456navigator.serviceWorker.register(&apos;your_service_worker,js&apos;, &amp;#123; scope: &apos;your_path_name&apos; &amp;#125;).then((worker) =&amp;gt; &amp;#123;  console.log(&apos;[SW] Registration succeeded.&apos;)&amp;#125;).catch((er">
<meta name="twitter:image" content="http://foio.github.io/images/sw-lifecycle.png">
  
    <link rel="alternate" href="/atom.xml" title="EzCook" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/typing.css">
</head>

  
    
      <body class="dark">
    
  
      <div id="container" class="container">
        <article id="post-Simple-usage-of-SW" class="article article-type-post" itemscope itemprop="blogPost">
  <header id="header" class="header">
  <nav id="main-nav" class="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    
      <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
    
  </nav>
</header>

  <hr/>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Simple usage of SW
    </h1>
  

      </header>
    
    <div class="article-entry typo" itemprop="articleBody">
      
        <h1 id="Register"><a href="#Register" class="headerlink" title="Register"></a>Register</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">navigator.serviceWorker.register(<span class="string">'your_service_worker,js'</span>, &#123; <span class="attr">scope</span>: <span class="string">'your_path_name'</span> &#125;)</div><div class="line">.then(<span class="function">(<span class="params">worker</span>) =&gt;</span> &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'[SW] Registration succeeded.'</span>)</div><div class="line">&#125;).catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'[SW] Registration failed with '</span> + err)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h1 id="Unregister"><a href="#Unregister" class="headerlink" title="Unregister"></a>Unregister</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">navigator.serviceWorker.getRegistration(<span class="string">'your_service_worker.js'</span>, &#123; <span class="attr">scope</span>: <span class="string">'your_path_name'</span> &#125;)</div><div class="line">.then(<span class="function">(<span class="params">worker</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">if</span> (worker &amp;&amp; worker.unregister) &#123;</div><div class="line">    worker.unregister()</div><div class="line">    .then(<span class="function">(<span class="params">isUnregistered</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">if</span> (isUnregistered) &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'[SW] Unregister succeeded'</span>)</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'[SW] Unregister failed'</span>)</div><div class="line">      &#125;</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line">&#125;)</div><div class="line">.catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'[SW] Unregister failed with '</span> + err)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h1 id="Worker-js"><a href="#Worker-js" class="headerlink" title="Worker.js"></a>Worker.js</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">self.addEventListener(<span class="string">'install'</span>, (event) =&gt; &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'[Worker] installing'</span>)</div><div class="line">&#125;)</div><div class="line"></div><div class="line">self.addEventListener(<span class="string">'activate'</span>, (event) =&gt; &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'[Worker] ready'</span>)</div><div class="line">&#125;)</div><div class="line"></div><div class="line">self.addEventListener(<span class="string">'fetch'</span>, (event) =&gt; &#123;</div><div class="line">  <span class="built_in">console</span>.log(event.request.url)</div><div class="line">  <span class="keyword">return</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h1 id="LifeCycle"><a href="#LifeCycle" class="headerlink" title="LifeCycle"></a>LifeCycle</h1><p><img src="http://foio.github.io/images/sw-lifecycle.png" alt=""></p>
<h1 id="Download-and-Parse"><a href="#Download-and-Parse" class="headerlink" title="Download and Parse"></a>Download and Parse</h1><p>After registration of Service Worker, browser will download and parse the script from specified url.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* In main.js */</span></div><div class="line"><span class="keyword">if</span> (<span class="string">'serviceWorker'</span> <span class="keyword">in</span> navigator) &#123;</div><div class="line">  navigator.serviceWorker.register(<span class="string">'./sw.js'</span>)</div><div class="line">  .then(<span class="function">(<span class="params">worker</span>) =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'Service Worker Registered'</span>)</div><div class="line">  &#125;)</div><div class="line">  .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'Service Worker Failed to Register'</span>)</div><div class="line">  &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Installing"><a href="#Installing" class="headerlink" title="Installing"></a>Installing</h1><p>After successfully parsed, browser will install the Service Worker. Once the Install finished, the worker will emit <code>install</code> event, and waiting for <code>activating</code>. If the install failed, Service Worker will be <code>Redundant</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* In sw.js */</span></div><div class="line">self.addEventListener(<span class="string">'install'</span>, (event) =&gt; &#123;</div><div class="line">  event.waitUntil(</div><div class="line">    caches.open(currentCacheName)</div><div class="line">    .then(<span class="function">(<span class="params">cache</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">return</span> cache.addAll(arrayOfFilesToCache)</div><div class="line">    &#125;)</div><div class="line">  )</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>If there is an <code>event.waitUntil(promiseObj)</code> method in the event, the installing event will not be successful until the Promise within it is solved. If the Promise is rejected, the install event fails and the Service Worker became <strong>redundant</strong></p>
<h1 id="Installed-Waiting"><a href="#Installed-Waiting" class="headerlink" title="Installed / Waiting"></a>Installed / Waiting</h1><p>If the installation is successful, the Service Worker moves to the <strong>installed</strong>(also called <strong>waiting</strong>) state. In this state it is a valid, but not yet active, worker. It is not yet in control of the document., but rather is waiting to take control form the current worker.</p>
<h1 id="Activating"><a href="#Activating" class="headerlink" title="Activating"></a>Activating</h1><p>The <strong>activating</strong> state will be triggered for a waiting Service Worker in one of the following scenarios -</p>
<ul>
<li><p>if there is no current active worker already</p>
</li>
<li><p>if the <code>self.skipWaiting()</code> method is called in the Service Worker script</p>
</li>
<li><p>if the user has navigated away from the page, thereby releasing the previous active worker.</p>
</li>
<li><p>if a specified period of time has passed, thereby releasing the previous active worker</p>
</li>
</ul>
<p>During the activating state, the <strong>active</strong> event in the Service Worker script is carried out. In a typical activate event, we clear files from old caches.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* In sw.js */</span></div><div class="line">self.addEventListener(<span class="string">'activate'</span>, (event) =&gt; &#123;</div><div class="line">  event.waitUntil(</div><div class="line">    <span class="comment">// get all the cache names</span></div><div class="line">    caches.keys().then(<span class="function">(<span class="params">cacheNames</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.all(</div><div class="line">        cacheNames.filter(<span class="function">(<span class="params">cacheName</span>) =&gt;</span> &#123;</div><div class="line"></div><div class="line">        &#125;)</div><div class="line">      )</div><div class="line">    &#125;)</div><div class="line">  )</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h1 id="Activate"><a href="#Activate" class="headerlink" title="Activate"></a>Activate</h1><p>If the worker is activated, it will emit <code>active</code> event, and take over all fetch from page. If active failed, the worker will be <code>Redundant</code></p>
<h1 id="Redundant"><a href="#Redundant" class="headerlink" title="Redundant"></a>Redundant</h1><p>Once a worker is redundant, it wonâ€™t have effect on page.</p>
<h1 id="Dependencies"><a href="#Dependencies" class="headerlink" title="Dependencies"></a>Dependencies</h1><ul>
<li><p>fetch</p>
</li>
<li><p>promise</p>
</li>
<li><p>CacheStorage: store Cache Object</p>
</li>
<li><p>Cache: store Request/Response Pair Object</p>
</li>
</ul>
<p><img src="http://foio.github.io/images/sw-cache-storage.png" alt=""></p>
<h1 id="Example-Cache-Static-Resource"><a href="#Example-Cache-Static-Resource" class="headerlink" title="Example: Cache Static Resource"></a>Example: Cache Static Resource</h1><ul>
<li><p>listen to install to cache static resource</p>
</li>
<li><p>listen to fetch to intercept request and return cached static Resource</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> CACHE_NAME = <span class="string">'my-site-cache-v1'</span></div><div class="line"><span class="keyword">var</span> urlsToCache = [</div><div class="line">  <span class="string">'/'</span>,</div><div class="line">  <span class="string">'/styles/main.css'</span>,</div><div class="line">  <span class="string">'/script/main.js'</span>,</div><div class="line">]</div><div class="line"></div><div class="line"><span class="comment">// cache resource after installation</span></div><div class="line">self.addEventListener(<span class="string">'install'</span>, (event) =&gt; &#123;</div><div class="line">  <span class="comment">// perform install steps</span></div><div class="line">  event.waitUntil(</div><div class="line">    caches.open(CACHE_NAME)</div><div class="line">    .then(<span class="function">(<span class="params">cache</span>) =&gt;</span> &#123;</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">'Opened Cache'</span>)</div><div class="line">      <span class="keyword">return</span> cache.addAll(urlsToCache)</div><div class="line">    &#125;)</div><div class="line">  )</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="comment">// listen to fetch, use cache if cached</span></div><div class="line">self.addEventListener(<span class="string">'fetch'</span>, (event) =&gt; &#123;</div><div class="line">  event.responseWith(</div><div class="line">    caches.match(event.request)</div><div class="line">    .then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">if</span> (response) &#123;</div><div class="line">        <span class="keyword">return</span> response</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> fetch(event.request)</div><div class="line">    &#125;)</div><div class="line">  )</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h1 id="Version-Controls"><a href="#Version-Controls" class="headerlink" title="Version Controls"></a>Version Controls</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> deleteObsoleteCache = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">  <span class="keyword">return</span> caches.keys().then(<span class="function">(<span class="params">keys</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">var</span> all = keys.map(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">if</span> (key.indexOf(CACHE_PREFIX) !== <span class="number">-1</span> &amp;&amp; key.indexOf(CACHE_VERSION) === <span class="number">-1</span>) &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'[SW] Delete cache: '</span> + key)</div><div class="line">        <span class="keyword">return</span> caches.delete(key)</div><div class="line">      &#125;</div><div class="line">    &#125;)</div><div class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.all(all)</div><div class="line">  &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Whitelist"><a href="#Whitelist" class="headerlink" title="Whitelist"></a>Whitelist</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// resource whitelist</span></div><div class="line"><span class="keyword">const</span> allAssets = [</div><div class="line">  <span class="string">'//your.cdn.com/app.css'</span>,</div><div class="line">  <span class="string">'//your.cdn.com/app.js'</span>,</div><div class="line">]</div><div class="line"></div><div class="line"><span class="comment">// match</span></div><div class="line"><span class="keyword">const</span> matchAssets = <span class="function">(<span class="params">requestUrl</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">const</span> urlObj = <span class="keyword">new</span> URL(requestUrl)</div><div class="line">  <span class="keyword">const</span> noProtocolUrl = urlObj.href.substr(urlObj.protocol.length)</div><div class="line">  <span class="keyword">if</span> (allAssets.includes(noProtocolUrl)) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// listen to fetch, proxy fetch matching Whitelist</span></div><div class="line">self.addEventListener(<span class="string">'fetch'</span>, (event) =&gt; &#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">const</span> requestUrl = event.target.url</div><div class="line">    <span class="keyword">const</span> isGet = event.request.method === <span class="string">'GET'</span></div><div class="line">    <span class="keyword">const</span> assetMatches = matchAssets(requestUrl)</div><div class="line">    <span class="keyword">if</span> (!assetMatches || !isGet) &#123;</div><div class="line">      <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">const</span> resource = cacheFirstResponse(event)</div><div class="line">    event.responseWith(resource)</div><div class="line">  &#125; cache (err) &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'[SW] handle fetch event error'</span>)</div><div class="line">    <span class="keyword">return</span></div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <ul class="article-meta">
        <li>
          <span class="label">Published Date:</span>
          <a href="/2017/07/01/Simple-usage-of-SW/" class="article-date">
  <time datetime="2017-07-01T06:52:04.000Z" itemprop="datePublished">2017-07-01</time>
</a>

        </li>
        
        
        <hr/>
      </ul>
    </footer>
  </div>
  
    
<nav id="article-nav" class="article-nav">
  
    <a href="/2017/07/07/Notes-on-Interactive-Data-Visualization-for-the-Web/" id="article-nav-newer" class="article-nav-link-wrap newer">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Notes on Interactive Data Visualization for the Web
        
      </div>
    </a>
  
  
    <a href="/2017/07/01/Glossary-of-Terms-on-InfluxDB/" id="article-nav-older" class="article-nav-link-wrap older">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Glossary of Terms on InfluxDB</div>
    </a>
  
</nav>


  
</article>




      </div>
      
    <footer id="footer" class="post-footer footer">
      <hr/>
      <div id="footerContent" class="footer-content">
        <p>Write for Archive</p>


      </div>
    </footer>

      

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/typing.js"></script>
<!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->







    </div>
  </body>
</html>
