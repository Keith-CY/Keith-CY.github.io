<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Connect 相关 | EzCook</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Connect 相关</h1><a id="logo" href="/.">EzCook</a><p class="description">Code Elegantly</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Connect 相关</h1><div class="post-meta">Aug 22, 2016<span> | </span><span class="category"><a href="/categories/note/">note</a></span></div><div class="post-content"><h1 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h1><p>回顾一下 Redux 基本用法</p>
<pre><code>const reducer = (state = {count: 0}, action ) =&amp;gt; {
  switch(action.type){
  case &quot;INCRESE&quot;: return {count: state.count + 1}
  case &quot;DECRESE&quot;: return {count: state.count - 1}
  default: return state;
  }
}

const actions = {
  increase: () =&amp;gt; { type: &apos;INCREASE&apos;},
  decrease: () =&amp;gt; { type: &apos;DECREASE&apos;}
}

const store = createStore(reducer);

store.subscribe(()=&amp;gt;{
  console.log(store.getState())
});

store.dispatch(action.increase());
`&lt;/pre&gt;

通过 reducer 创建一个 store, 每当我们在 store 上 dispatch 一个 action, store 内的数据就会通过 reducer 变化.

我们当然可以直接在 React 中使用 Redux, 在最外层容器中初始化 store, 然后将 state 上的属性作为 props 层层传下去

&lt;pre&gt;`class App extends Component{
  componentWillMount(){
    store.subscribe((state) =&amp;gt; this.setState(state))
  }
  render(){
    return &amp;lt;Comp state={this.state} onIncrease = {()=&amp;gt;store.dispatch(actions.increase())} onDecrease = {()=&amp;gt; store.dispatch(actions.decrease())}
  } /&amp;gt;
}
`&lt;/pre&gt;

但这不是最佳方式, 最佳方式是使用 react-redux 提供的 Provider 和 connect 方法

### 使用 React-redux

首先在最外层容器中, 把所有内容包裹在 Provider 组件中, 将之前创建的 store 作为 prop 传递给 Provider

&lt;pre&gt;`const App = () =&amp;gt; {
  return(
    &amp;lt;Provider store = {store}&amp;gt;
      &amp;lt;Comp /&amp;gt;
    &amp;lt;/Provider&amp;gt;
  )
}
`&lt;/pre&gt;

Provider 中的任何一个组件(比如这里的 Comp) 如果需要使用 state 中的数据, 就必须是 `被 connect 过的`组件, 使用 connect 方法对你编写的组件(MyComp)进行包装后的产物.

&lt;pre&gt;`class MyComp extends Component {
  // content...
}

const Comp = connect(...args)(MyComp);
`&lt;/pre&gt;

可见 connect 是重中之重

### connect 详解

究竟 connect 做了什么

首先看一下函数的签名:

&lt;pre&gt;`connect([mapStatToProps], [mapDispatchToProps], [mergeProps], [options])
`&lt;/pre&gt;

connect() 函数接受四个参数, 分别是

&lt;pre&gt;`mapStatToProps, mapDispatchToProps, mergeProps, options
`&lt;/pre&gt;

&lt;pre&gt;`mapStatToProps(state, ownProps): stateProps
`&lt;/pre&gt;

这个函数允许我们将 store 中的数据作为 props 绑定到组件上

&lt;pre&gt;`const mapStatToProps = (state) =&amp;gt; {
  return {
    count: state.count
  }
}
`&lt;/pre&gt;

这个函数的第一个参数就是 Redux 的 store, 我们从中摘取 count 属性, 因为返回了具有 count 属性的对象, 所以 MyComp 会有名为 count 的 props 字段

&lt;pre&gt;`class MyComp extends Component{
  render(){
    return &amp;lt;div&amp;gt;Count: {this.props.count}&amp;lt;/div&amp;gt;
  }
}

const Comp = connect(...args)(MyComp);
`&lt;/pre&gt;

当然你不必将 state 原封不动传递给组件, 可以根据 state 中的数据, 动态的输出组件需要的(最小)属性

&lt;pre&gt;`const mapStateToProps = (state) =&amp;gt; {
  return {
    greaterThanFive: state.count &amp;gt; 5
  }
}
`&lt;/pre&gt;

第二个参数 ownProps, 是 MyComp 自己的 props, 有时候 ownProps 也会对其产生影响, 比如当你在 store 中维护一个用户列表, 而你的组件 MyComp 只关心一个用户(通过 props 中的 userId体现)

&lt;pre&gt;`const mapStateToProps = (state, ownProps) =&amp;gt; {
  // state 是{ userList:[{id:0,name;&apos;王二&apos;}]}
  return {
    user: _.find(state.userList, {id:ownProps.userId})
  }
}

class MyComp extends Component{
  static PropTypes = {
    userId: PropTypes.string.isRequired,
    user: PropTypes.object
  };
  render(){
    return &amp;lt;div&amp;gt;UserName: {this.props.user.name}&amp;lt;/div&amp;gt;
  }
}

const Comp = connect(mapStateToProps)(MyComp)
`&lt;/pre&gt;

当 state 变化, 或者 ownProps 变化时, mapStateToProps 都会被调用, 计算出一个新的 stateProps , 在与 ownProps merge 后, 更新给 MyComp

这就是将 Redux store 中的数据连接到组件的基本方法

mapDispatchToProps(dispatch, ownProps): dispatchProps

connect 的第二个参数是 mapDispatchToProps, 功能是将 action 作为 props 绑定到 MyComp 上

&lt;pre&gt;`const mapDispatchToProps = (dispatch, ownProps) =&amp;gt; {
  return {
    increase: (...args) =&amp;gt; dispatch(actions.increase(...args)),
    decrease: (...args) =&amp;gt; dispatch(actions.decrease(...args))
  }
}

class MyComp extends Component{
  render(){
    const {count, increase, decrease} = this.props
    return (
      &amp;lt;div&amp;gt;
        &amp;lt;div&amp;gt;Count:{count}&amp;lt;/div&amp;gt;
        &amp;lt;button onClick={increase}&amp;gt;+&amp;lt;/button&amp;gt;
        &amp;lt;button onClick={decrease}&amp;gt;-&amp;lt;/button&amp;gt;
      &amp;lt;/div&amp;gt;
    )
  }
}

const Comp = connect(mapStateToProps, mapDispatchToProps)(MyComp)
`&lt;/pre&gt;

由于 mapDispatchToProps 方法返回了具有 increase 属性和 decrease 属性的对象, 这两个属性也会成为 MyComp 的 props

如上所示, 调用 actions.increase()只能得到一个 action 对象{type:&apos;INCREASE&apos;}, 要触发这个 action 必须要通过 dispatch 调用, dispatch 正式 mapDispatchToProps 的第一个参数, 但是为了不让 MyComp 组件感知到 dispatch 的存在, 我们需要将 increase 和 decrease 方法包装一下, 使之成为直接可以被调用的函数(即触发该方法就会触发 dispatch)

Redux 本身提供了 bindActionCreator 函数, 来将 action 包装成可以直接被调用的函数

&lt;pre&gt;`import {bindActionCreator} from &apos;redux&apos;
const mapDispatchToProps = (dispatch,ownProps) =&amp;gt; {
  return bindActionCreator({
    increase: actions.increase,
    decrease: actions.decrease
  })
}
</code></pre><p>同样当 ownProps 变化时, 该函数也会被调用, 生成一个新的 dispatchProps( 在与 stateProps 和 ownPorps merge 后), 更新给 MyComp. 注意 action 的变化不会引起上述过程, 默认 action 在组件的生命周期中是固定的</p>
<p>[mergeProps(stateProps, dispatchProps, ownProps): props]</p>
<p>之前说过不管是 stateProps 还是 dispatchProps, 都需要和 ownProps merge 之后才会被赋给 MyComp, connect 的第三个参数就是来做这个事情的, 通常情况下不需要传这个参数, connect 会使用 Object.assign 方法代替该方法.</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>最后还有一个 options 参数, 比较简单, 一般也不会用到.</p>
<p><a href="http://taobaofed.org/blog/2016/08/18/react-redux-connect/" target="_blank" rel="noopener">参考</a></p>
</div><div class="tags"><a href="/tags/Redux/">Redux</a><a href="/tags/React/">React</a><a href="/tags/React-Redux/">React-Redux</a></div><div class="post-nav"><a class="pre" href="/2016/08/23/middleware/">Middleware</a><a class="next" href="/2016/08/22/configuring-eslint/">Configuring ESLint</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Soup/">Soup</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Uncategorized/">Uncategorized</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/github/">github</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/github/note/">note</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/note/">note</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/note/workNote/">workNote</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/workNote/">workNote</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/commandline/" style="font-size: 15px;">commandline</a> <a href="/tags/CSS3/" style="font-size: 15px;">CSS3</a> <a href="/tags/jQuery/" style="font-size: 15px;">jQuery</a> <a href="/tags/Trick/" style="font-size: 15px;">Trick</a> <a href="/tags/Material-Design/" style="font-size: 15px;">Material Design</a> <a href="/tags/GraphQL-Apollo-TypeScript/" style="font-size: 15px;">GraphQL, Apollo, TypeScript</a> <a href="/tags/Phoenix-Elixir-Ecto/" style="font-size: 15px;">Phoenix, Elixir, Ecto</a> <a href="/tags/Int8Array/" style="font-size: 15px;">Int8Array</a> <a href="/tags/Node-CLI/" style="font-size: 15px;">Node, CLI</a> <a href="/tags/ETH-Wallet/" style="font-size: 15px;">ETH, Wallet</a> <a href="/tags/BlockChain/" style="font-size: 15px;">BlockChain</a> <a href="/tags/Contract-Solidity/" style="font-size: 15px;">Contract, Solidity</a> <a href="/tags/Solidity/" style="font-size: 15px;">Solidity</a> <a href="/tags/Smart-Contract-Web3/" style="font-size: 15px;">Smart Contract, Web3</a> <a href="/tags/Ruby-Rails-RoR-Mina/" style="font-size: 15px;">Ruby, Rails, RoR, Mina</a> <a href="/tags/React-Docker/" style="font-size: 15px;">React, Docker</a> <a href="/tags/Ethereum-IPFS/" style="font-size: 15px;">Ethereum, IPFS</a> <a href="/tags/Solidity-Error-Handling/" style="font-size: 15px;">Solidity, Error Handling</a> <a href="/tags/Node-Fastify/" style="font-size: 15px;">Node, Fastify</a> <a href="/tags/Erlang-Elixir-GenServer/" style="font-size: 15px;">Erlang, Elixir, GenServer</a> <a href="/tags/Ethereum/" style="font-size: 15px;">Ethereum</a> <a href="/tags/Solidity-Public-External/" style="font-size: 15px;">Solidity, Public, External</a> <a href="/tags/Webpack/" style="font-size: 15px;">Webpack</a> <a href="/tags/HTTP2-Node/" style="font-size: 15px;">HTTP2, Node</a> <a href="/tags/Go-Http-Web/" style="font-size: 15px;">Go, Http, Web</a> <a href="/tags/JSON-RPC/" style="font-size: 15px;">JSON-RPC</a> <a href="/tags/Ruby-Rails/" style="font-size: 15px;">Ruby, Rails</a> <a href="/tags/Rust-Rocket/" style="font-size: 15px;">Rust, Rocket</a> <a href="/tags/D3-Example/" style="font-size: 15px;">D3, Example</a> <a href="/tags/DAPP-Solidity/" style="font-size: 15px;">DAPP, Solidity</a> <a href="/tags/Pug-HTML/" style="font-size: 15px;">Pug, HTML</a> <a href="/tags/Drizzle-Ethereum-BlockChain/" style="font-size: 15px;">Drizzle, Ethereum, BlockChain</a> <a href="/tags/Protobuf/" style="font-size: 15px;">Protobuf</a> <a href="/tags/Mock-JavaScript/" style="font-size: 15px;">Mock, JavaScript</a> <a href="/tags/Blockchain/" style="font-size: 15px;">Blockchain</a> <a href="/tags/DApp-Solidity/" style="font-size: 15px;">DApp, Solidity</a> <a href="/tags/babel/" style="font-size: 15px;">babel</a> <a href="/tags/babel-polyfill/" style="font-size: 15px;">babel-polyfill</a> <a href="/tags/Redux/" style="font-size: 15px;">Redux</a> <a href="/tags/Javascript/" style="font-size: 15px;">Javascript</a> <a href="/tags/RxJS/" style="font-size: 15px;">RxJS</a> <a href="/tags/BOOTSTRAP/" style="font-size: 15px;">BOOTSTRAP</a> <a href="/tags/HTML5/" style="font-size: 15px;">HTML5</a> <a href="/tags/Bash/" style="font-size: 15px;">Bash</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/CommonJS/" style="font-size: 15px;">CommonJS</a> <a href="/tags/Node-js/" style="font-size: 15px;">Node.js</a> <a href="/tags/React/" style="font-size: 15px;">React</a> <a href="/tags/webpack/" style="font-size: 15px;">webpack</a> <a href="/tags/ESLint/" style="font-size: 15px;">ESLint</a> <a href="/tags/React-Redux/" style="font-size: 15px;">React-Redux</a> <a href="/tags/DOM/" style="font-size: 15px;">DOM</a> <a href="/tags/NPM/" style="font-size: 15px;">NPM</a> <a href="/tags/Gulp/" style="font-size: 15px;">Gulp</a> <a href="/tags/github/" style="font-size: 15px;">github</a> <a href="/tags/CSS/" style="font-size: 15px;">CSS</a> <a href="/tags/Web/" style="font-size: 15px;">Web</a> <a href="/tags/ES6/" style="font-size: 15px;">ES6</a> <a href="/tags/Thunk/" style="font-size: 15px;">Thunk</a> <a href="/tags/AJAX/" style="font-size: 15px;">AJAX</a> <a href="/tags/测试/" style="font-size: 15px;">测试</a> <a href="/tags/Koa/" style="font-size: 15px;">Koa</a> <a href="/tags/NODE/" style="font-size: 15px;">NODE</a> <a href="/tags/webpack2/" style="font-size: 15px;">webpack2</a> <a href="/tags/CORS/" style="font-size: 15px;">CORS</a> <a href="/tags/Elixir-Phoenix-SCSS/" style="font-size: 15px;">Elixir, Phoenix, SCSS</a> <a href="/tags/FP/" style="font-size: 15px;">FP</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/Node-Graphql-Koa/" style="font-size: 15px;">Node, Graphql, Koa</a> <a href="/tags/automatic/" style="font-size: 15px;">automatic</a> <a href="/tags/Immutable/" style="font-size: 15px;">Immutable</a> <a href="/tags/Closure/" style="font-size: 15px;">Closure</a> <a href="/tags/DevTools/" style="font-size: 15px;">DevTools</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/MDL/" style="font-size: 15px;">MDL</a> <a href="/tags/Webpack-DLL/" style="font-size: 15px;">Webpack, DLL</a> <a href="/tags/precache/" style="font-size: 15px;">precache</a> <a href="/tags/Promise/" style="font-size: 15px;">Promise</a> <a href="/tags/React-Native/" style="font-size: 15px;">React-Native</a> <a href="/tags/React-Router/" style="font-size: 15px;">React-Router</a> <a href="/tags/React-Router-Code-splitting/" style="font-size: 15px;">React, Router, Code-splitting</a> <a href="/tags/RegExp/" style="font-size: 15px;">RegExp</a> <a href="/tags/Html-Picture/" style="font-size: 15px;">Html, Picture</a> <a href="/tags/Koa-NPM-Package/" style="font-size: 15px;">Koa, NPM, Package</a> <a href="/tags/Nock/" style="font-size: 15px;">Nock</a> <a href="/tags/Solidity-Smart-Contract/" style="font-size: 15px;">Solidity, Smart Contract</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/05/16/GenServer-in-Erlang/">GenServer in Erlang</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/15/Association-in-Phoenix/">Association in Phoenix</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/15/cast-assoc/">Difference Bwtween Build_assoc, Put_assoc, and Cast_assoc</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/14/Introduction-to-Object-getOwnPropertyDescriptors/">Introduction to Object.getOwnPropertyDescriptors</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/06/enable-sass-scss-in-phoenix/">Enable Sass/scss in Phoenix</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/14/Model-Generator-of-Rails/">Model Generator of Rails</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/13/Error-Handling-in-Solidity/">Error Handling in Solidity</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/13/Start-in-Drizzle/">Start in Drizzle </a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/12/Constant-View-and-Pure-in-Solidity/">Constant, View, and Pure in Solidity</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/05/Writing-Upgradable-Contracts-in-Solidity/">Writing Upgradable Contracts in Solidity</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://github.com/Keith-CY" title="Github" target="_blank">Github</a><ul></ul><a href="https://www.linkedin.com/in/%E5%AE%87-%E9%99%88-644b61ba/" title="LinkedIn" target="_blank">LinkedIn</a><ul></ul><a href="https://www.facebook.com/keithwhisper" title="Facebook" target="_blank">Facebook</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">EzCook.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>