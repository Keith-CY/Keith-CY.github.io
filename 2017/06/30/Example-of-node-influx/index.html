<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  <title>Example of node-influx | EzCook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Express Response Times ExampleIn this example we’ll create a server which has an index page that prints out ‘hello world’, and a page http://localhost:3000/times which prints out the last ten response">
<meta property="og:type" content="article">
<meta property="og:title" content="Example of node-influx">
<meta property="og:url" content="http://yoursite.com/2017/06/30/Example-of-node-influx/index.html">
<meta property="og:site_name" content="EzCook">
<meta property="og:description" content="Express Response Times ExampleIn this example we’ll create a server which has an index page that prints out ‘hello world’, and a page http://localhost:3000/times which prints out the last ten response">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2017-06-30T02:03:51.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Example of node-influx">
<meta name="twitter:description" content="Express Response Times ExampleIn this example we’ll create a server which has an index page that prints out ‘hello world’, and a page http://localhost:3000/times which prints out the last ten response">
  
    <link rel="alternate" href="/atom.xml" title="EzCook" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/typing.css">
</head>

  
    
      <body class="dark">
    
  
      <div id="container" class="container">
        <article id="post-Example-of-node-influx" class="article article-type-post" itemscope itemprop="blogPost">
  <header id="header" class="header">
  <nav id="main-nav" class="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    
      <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
    
  </nav>
</header>

  <hr/>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Example of node-influx
    </h1>
  

      </header>
    
    <div class="article-entry typo" itemprop="articleBody">
      
        <h1 id="Express-Response-Times-Example"><a href="#Express-Response-Times-Example" class="headerlink" title="Express Response Times Example"></a>Express Response Times Example</h1><p>In this example we’ll create a server which has an index page that prints out ‘hello world’, and a page</p>
<p><code>http://localhost:3000/times</code> which prints out the last ten response times that influxDB gave us.</p>
<p>The end result should look something like this:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">curl <span class="_">-s</span> localhost:3000</div><div class="line">Hello world</div><div class="line"></div><div class="line">curl <span class="_">-s</span> localhost:3000/<span class="built_in">times</span> | jq</div><div class="line">[</div><div class="line">  &#123;</div><div class="line">    <span class="string">"time"</span>: <span class="string">"2016-10-09T19:13:26.815Z"</span>,</div><div class="line">    <span class="string">"duration"</span>: 205,</div><div class="line">    <span class="string">"host"</span>: <span class="string">"ares.peet.io"</span>,</div><div class="line">    <span class="string">"path"</span>: <span class="string">"/"</span></div><div class="line">    &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<p>Get started by installing and importing everything we need. This example requires Node 6.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install influx express</div></pre></td></tr></table></figure>
<p>Now create a new file <code>app.js</code> and start writing</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> Influx = <span class="built_in">require</span>(<span class="string">'../../'</span>)</div><div class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</div><div class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</div><div class="line"><span class="keyword">const</span> os = <span class="built_in">require</span>(<span class="string">'os'</span>)</div><div class="line"></div><div class="line"><span class="keyword">const</span> app = express()</div></pre></td></tr></table></figure>
<p>Create a new influx client. We tell it to use the <code>express_response_db</code> database by default, and give it some information about the schema we’re writing. It can use this to be smarter about what data formats it writes and do some basic validation for us.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> influx = <span class="keyword">new</span> Influx.InfluxBD(&#123;</div><div class="line">  <span class="attr">host</span>: <span class="string">'localhost'</span>,</div><div class="line">  <span class="attr">database</span>: <span class="string">'express_response_db'</span>,</div><div class="line">  <span class="attr">schema</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">measurement</span>: <span class="string">'response_time'</span>,</div><div class="line">      <span class="attr">fields</span>: &#123;</div><div class="line">        <span class="attr">path</span>: Influx.FieldType.STRING,</div><div class="line">        <span class="attr">duration</span>: Influx.FieldType.INTEGER</div><div class="line">      &#125;,</div><div class="line">      <span class="attr">tags</span>: [</div><div class="line">        <span class="string">'host'</span></div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>Now we have a working influx client!</p>
<p>We’ll make sure the database exists and boot the app.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">influx.getDatabaseName()</div><div class="line">.then(<span class="function"><span class="params">names</span> =&gt;</span> &#123;</div><div class="line">  <span class="keyword">if</span> (!names.includes(<span class="string">'express_response_db'</span>)) &#123;</div><div class="line">    <span class="keyword">return</span> influx.createDatabase(<span class="string">'express_response_db'</span>)</div><div class="line">  &#125;</div><div class="line">&#125;)</div><div class="line">.then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">  http.createServer(app).listen(<span class="number">3000</span>, () =&gt; &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'Listening on port 3000'</span>)</div><div class="line">  &#125;)</div><div class="line">&#125;)</div><div class="line">.catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</div><div class="line">  <span class="built_in">console</span>.error(<span class="string">'Error creating Influx database'</span>)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>Finally we’ll define the middleware and routes we’ll use. We have a generic middleware that records the time between when requests comes in, and the time we response to them. We also have another route called <code>/times</code> which prints out the last ten timings we recorded.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">app.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">const</span> start = <span class="built_in">Date</span>.now()</div><div class="line">  res.on(<span class="string">'finish'</span>, () =&gt; &#123;</div><div class="line">    <span class="keyword">const</span> duration = <span class="built_in">Date</span>.now() - start</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">`Request to <span class="subst">$&#123;req.path&#125;</span> took <span class="subst">$&#123;duration&#125;</span> ms`</span>)</div><div class="line">    influx.writePoints([</div><div class="line">      &#123;</div><div class="line">        <span class="attr">measurement</span>: <span class="string">'response_times'</span>,</div><div class="line">        <span class="attr">tags</span>: &#123; <span class="attr">host</span>: os.hostname() &#125;,</div><div class="line">        <span class="attr">fields</span>: &#123; duration, <span class="attr">path</span>: req.path &#125;</div><div class="line">      &#125;</div><div class="line">    ]).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">`Error saving data to InfluxDB: <span class="subst">$&#123;err.stack&#125;</span>`</span>)</div><div class="line">    &#125;)</div><div class="line">  &#125;)</div><div class="line">  <span class="keyword">return</span> next()</div><div class="line">&#125;)</div><div class="line"></div><div class="line">app.get(<span class="string">'/'</span>, (req, res) =&gt; &#123;</div><div class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> res.end(<span class="string">'Hello world'</span>), <span class="built_in">Math</span>.random() * <span class="number">500</span>)</div><div class="line">&#125;)</div><div class="line"></div><div class="line">app.get(<span class="string">'/times'</span>, (req, res) =&gt; &#123;</div><div class="line">  influx.query(<span class="string">`</span></div><div class="line">      select * from response_times</div><div class="line">      where host = <span class="subst">$&#123;Influx.<span class="built_in">escape</span>.stringLit(os.hostname())&#125;</span></div><div class="line">      order by time desc</div><div class="line">      limit 10</div><div class="line">  `).then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</div><div class="line">    res.json(result)</div><div class="line">  &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</div><div class="line">    res.status(<span class="number">500</span>).send(err.stack)</div><div class="line">  &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <ul class="article-meta">
        <li>
          <span class="label">Published Date:</span>
          <a href="/2017/06/30/Example-of-node-influx/" class="article-date">
  <time datetime="2017-06-30T01:09:56.000Z" itemprop="datePublished">2017-06-30</time>
</a>

        </li>
        
        
        <hr/>
      </ul>
    </footer>
  </div>
  
    
<nav id="article-nav" class="article-nav">
  
    <a href="/2017/06/30/Usage-of-Node-Influx/" id="article-nav-newer" class="article-nav-link-wrap newer">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Usage of Node-Influx
        
      </div>
    </a>
  
  
    <a href="/2017/06/29/snippets-of-koa-middlewares/" id="article-nav-older" class="article-nav-link-wrap older">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">snippets of koa middlewares</div>
    </a>
  
</nav>


  
</article>




      </div>
      
    <footer id="footer" class="post-footer footer">
      <hr/>
      <div id="footerContent" class="footer-content">
        <p>Write for Archive</p>


      </div>
    </footer>

      

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/typing.js"></script>
<!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->







    </div>
  </body>
</html>
