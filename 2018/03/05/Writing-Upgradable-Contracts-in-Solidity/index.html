<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  <title>Writing Upgradable Contracts in Solidity | EzCook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="origin Ethereum contracts are immutable – once deployed to the blockchain they cannot be updated, yet the need to change their logic with time is ultimately necessary. During a contract upgrade the fo">
<meta name="keywords" content="DApp, Solidity">
<meta property="og:type" content="article">
<meta property="og:title" content="Writing Upgradable Contracts in Solidity">
<meta property="og:url" content="http://yoursite.com/2018/03/05/Writing-Upgradable-Contracts-in-Solidity/index.html">
<meta property="og:site_name" content="EzCook">
<meta property="og:description" content="origin Ethereum contracts are immutable – once deployed to the blockchain they cannot be updated, yet the need to change their logic with time is ultimately necessary. During a contract upgrade the fo">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2018-03-05T08:27:23.240Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Writing Upgradable Contracts in Solidity">
<meta name="twitter:description" content="origin Ethereum contracts are immutable – once deployed to the blockchain they cannot be updated, yet the need to change their logic with time is ultimately necessary. During a contract upgrade the fo">
  
    <link rel="alternate" href="/atom.xml" title="EzCook" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/typing.css">
</head>

  
    
      <body class="dark">
    
  
      <div id="container" class="container">
        <article id="post-Writing-Upgradable-Contracts-in-Solidity" class="article article-type-post" itemscope itemprop="blogPost">
  <header id="header" class="header">
  <nav id="main-nav" class="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    
      <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
    
  </nav>
</header>

  <hr/>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Writing Upgradable Contracts in Solidity
    </h1>
  

      </header>
    
    <div class="article-entry typo" itemprop="articleBody">
      
        <p><a href="https://blog.colony.io/writing-upgradeable-contracts-in-solidity-6743f0eecc88" target="_blank" rel="external">origin</a></p>
<p>Ethereum contracts are immutable – once deployed to the blockchain they cannot be updated, yet the need to change their logic with time is ultimately necessary.</p>
<p>During a contract upgrade the following factors need to be considered:</p>
<ul>
<li><p>Block gas limit(4712388 for Homestead)</p>
<p>Upgrade transaction tend to be large due to the amount of processing they have to complete e.g. <em>deploy a contract, move data, move references</em>.</p>
</li>
<li><p>Inter-contract dependencies</p>
<p><em>when a contract is compiled, all of its imports are compiled into the contract thus leading to a ripple effect when you want to swap out a contract which is being referenced by other contract</em>.</p>
</li>
</ul>
<p>These two are related, as having more dependencies affects the size of your deployed contracts and the overall transaction size of the upgrade. The implementation patterns below work to <em>minimise the upgrade gas costs as well as loosening the coupling of contracts without breaking Solidity type safety</em>.</p>
<p>Note that for the sake of simplying the examples, we have omitted the implementation of security and permission.</p>
<h3 id="Avoiding-large-data-copy-operations"><a href="#Avoiding-large-data-copy-operations" class="headerlink" title="Avoiding large data copy operations"></a>Avoiding large data copy operations</h3><p>Storing data is expensive(<code>SSTORE</code> operation costs 5000 or 20000 gas) and upgrading contracts containing large storage variables runs the chance of hitting the transaction gas limit during the copying of its data.</p>
<p><strong>You may therefore want to isolate your datastore from the rest of your code, and make it as flexible as possible, so that it is unlikely to need to be upgrade.</strong></p>
<p>Depending on your circumstances, how large of a datastore you need and whether you expect its structure to change often, you may choose a strict definition or a loosely typed flat store. Below is an example of the latter which implements support for storing a <em>sha3</em> key and value pairs. It is the more flexible and extensible option. This ensures data schema changes can be implemented without requiring upgrades to the storage contract.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">contract EternalStorage &#123;</div><div class="line">  mapping(<span class="function"><span class="params">bytes32</span> =&gt;</span> uint) UIntStorage;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getUIntValue</span>(<span class="params">bytes32 record</span>) <span class="title">constant</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> UIntStorage[record];</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setUIntValue</span>(<span class="params">bytes32 record, uint value</span>) </span>&#123;</div><div class="line">    UIntStorage[record] = value;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  mapping(<span class="function"><span class="params">bytes32</span> =&gt;</span> string) StringStorage;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getStringValue</span>(<span class="params">bytes32 record</span>) <span class="title">constant</span> <span class="title">returns</span> (<span class="params">string</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> StringStorage(record);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setStringValue</span>(<span class="params">bytes32 record, string value</span>) </span>&#123;</div><div class="line">    StringStorage[record] = value;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  mapping(<span class="function"><span class="params">bytes32</span> =&gt;</span> address) AddressStorage;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getAddressValue</span>(<span class="params">bytes32 record</span>) <span class="title">constant</span> <span class="title">returns</span> (<span class="params">address</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> AddressStorage[record];</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setAddressValue</span>(<span class="params">bytes32 record, address value</span>) </span>&#123;</div><div class="line">    AddressStorage[record] = value;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  mapping(<span class="function"><span class="params">bytes32</span> =&gt;</span> bytes) BytesStorage;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getBytesValue</span>(<span class="params">bytes32 record</span>) <span class="title">constant</span> <span class="title">returns</span> (<span class="params">bytes</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> BytesStorage[record];</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setBytesValue</span>(<span class="params">bytes32 record, bytes value</span>) </span>&#123;</div><div class="line">    BytesStorage[record] = value;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  mapping (<span class="function"><span class="params">bytes32</span> =&gt;</span> bool) BooleanStorage;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getBooleanValue</span>(<span class="params">bytes32 record</span>) <span class="title">constant</span> <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> BooleanStorage[record];</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setBooleanValue</span>(<span class="params">bytes32 record, bool value</span>) </span>&#123;</div><div class="line">    BooleanStorage[record] = value;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  mapping (<span class="function"><span class="params">bytes32</span> =&gt;</span> int) IntStorage;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getIntValue</span>(<span class="params">bytes32 record</span>) <span class="title">constant</span> <span class="title">returns</span> (<span class="params">int</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> IntStorage[record];</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setIntValue</span>(<span class="params">bytes32 record, int value</span>) </span>&#123;</div><div class="line">    IntStorage[record] = value;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>For upgrades you can then just switch the upgraded contract to point to the new EternalStorage contract instance without having a copy of its data.</p>
<h3 id="Use-Libraries-to-Encapsulate-Logic"><a href="#Use-Libraries-to-Encapsulate-Logic" class="headerlink" title="Use Libraries to Encapsulate Logic"></a>Use Libraries to Encapsulate Logic</h3><p>Libraries are special form of contracts that are singletons and not allowed any storage variables.</p>
<p>The advantage of libraries in the context of upgrades is that they allow encapsulation of business logic or data management logic into singleton instance that cost only upgrading one and not many contracts.</p>
<p>Example below shows a library used for adding a <em>Proposal</em> to storage.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="string">"EternalStorage.sol"</span>;</div><div class="line"></div><div class="line">library ProposalsLibrary &#123;</div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getProposalCount</span>(<span class="params">address _storageContract</span>) <span class="title">constant</span> <span class="title">returns</span> (<span class="params">uint256</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> EternalStorage(_storageContract).getUIntValue(sha3(<span class="string">"proposalCount"</span>));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">addProposal</span>(<span class="params">address _storageContract, bytes32 _name</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> idx = getProposalCount(_storageContract);</div><div class="line">    EternalStorage(_storageContract).setBytes32Value(sha3(<span class="string">"proposal_name"</span>, idx), _name);</div><div class="line">    EternalStorage(_storageContract).setUIntValue(sha3(<span class="string">"proposal_eth"</span>, idx), <span class="number">0</span>);</div><div class="line">    EternalStorage(_storageContract).setUIntValue(sha3(<span class="string">"ProposalCount"</span>), idx + <span class="number">1</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Under the cover, library functions are called using <code>delegatecall</code> from the calling contract which has the advantage of passing the <code>msg.sender</code> and <code>msg.value</code> seamlessly. You can therefore write your library code as if it were just part of your contract, without having to worry about the sender or value chagning.</p>
<p>The example below shows a sample <code>Organization</code> contract using <code>ProposalsLibrary</code> to interact with data storage.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="string">"ProposalsLibrary.sol"</span>;</div><div class="line"></div><div class="line">contract Organization &#123;</div><div class="line">  using ProposalsLibrary <span class="keyword">for</span> address;</div><div class="line">  address public eternalStorage;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Organization</span>(<span class="params">address _eternalStorage</span>) </span>&#123;</div><div class="line">    eternalStorage = _eternalStorage;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">addProposal</span>(<span class="params">bytes32 _name</span>) </span>&#123;</div><div class="line">    eternalStorage.addProposal(_name);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>With libraries, there is a slight gas overhead on each call. However, it makes deploying a new contract much cheaper.</p>
<h3 id="Use-‘interface’-to-decouple-inter-contract-communication"><a href="#Use-‘interface’-to-decouple-inter-contract-communication" class="headerlink" title="Use ‘interface’ to decouple inter-contract communication"></a>Use ‘interface’ to decouple inter-contract communication</h3><p>Abstract Contract implementation behind an interface that only define its function siguatures.</p>
<p>This is a well known pattern in object oriented programming.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="string">"ITokenLedger.sol"</span>;</div><div class="line"></div><div class="line">contract Organization &#123;</div><div class="line">  ITokenLedger public tokenLedger;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Organization</span>(<span class="params">address _tokenLedger</span>) </span>&#123;</div><div class="line">    tokenLedger = ITokenLedger(_tokenLedger);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">generateToekns</span>(<span class="params">uint256 _amount</span>) </span>&#123;</div><div class="line">    tokenLedger.generateTokens(_amount);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Here instead of importing the entire <code>TokenLedger.sol</code> contract, we use an interface containing just the function signatures. This eases any possible upgrades to TokenLedger which don’t affect its interface, too, which with this model can be implemented without redeploying the Organization contract.</p>

      
    </div>
    <footer class="article-footer">
      <ul class="article-meta">
        <li>
          <span class="label">Published Date:</span>
          <a href="/2018/03/05/Writing-Upgradable-Contracts-in-Solidity/" class="article-date">
  <time datetime="2018-03-05T06:30:17.000Z" itemprop="datePublished">2018-03-05</time>
</a>

        </li>
        
        
          <li>
            <span class="label">Tag:</span>
            
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DApp-Solidity/">DApp, Solidity</a></li></ul>


          </li>
        
        <hr/>
      </ul>
    </footer>
  </div>
  
    
<nav id="article-nav" class="article-nav">
  
    <a href="/2018/03/12/Constant-View-and-Pure-in-Solidity/" id="article-nav-newer" class="article-nav-link-wrap newer">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Constant, View, and Pure in Solidity
        
      </div>
    </a>
  
  
    <a href="/2018/02/28/Dockerizing-a-React-App/" id="article-nav-older" class="article-nav-link-wrap older">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Dockerizing a React App</div>
    </a>
  
</nav>


  
</article>




      </div>
      
    <footer id="footer" class="post-footer footer">
      <hr/>
      <div id="footerContent" class="footer-content">
        <p>Write for Archive</p>


      </div>
    </footer>

      

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/typing.js"></script>
<!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->







    </div>
  </body>
</html>
