<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  <title>HTTP/2 by Node.js | EzCook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Origin Websites delivered using HTTP/2 enjoys a wide range of new features including -  fully multiplexed connections: all requests and responses to a domain are fully multiplexed via a single connect">
<meta name="keywords" content="HTTP2, Node">
<meta property="og:type" content="article">
<meta property="og:title" content="HTTP&#x2F;2 by Node.js">
<meta property="og:url" content="http://yoursite.com/2017/11/07/HTTP-2-by-Node-js/index.html">
<meta property="og:site_name" content="EzCook">
<meta property="og:description" content="Origin Websites delivered using HTTP/2 enjoys a wide range of new features including -  fully multiplexed connections: all requests and responses to a domain are fully multiplexed via a single connect">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://dexecure.com//images/blog/waterfall-without-http2.53b722f2.png">
<meta property="og:image" content="https://dexecure.com//images/blog/waterfall-with-http2.b47218ea.png">
<meta property="og:updated_time" content="2017-11-07T02:50:52.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HTTP&#x2F;2 by Node.js">
<meta name="twitter:description" content="Origin Websites delivered using HTTP/2 enjoys a wide range of new features including -  fully multiplexed connections: all requests and responses to a domain are fully multiplexed via a single connect">
<meta name="twitter:image" content="https://dexecure.com//images/blog/waterfall-without-http2.53b722f2.png">
  
    <link rel="alternate" href="/atom.xml" title="EzCook" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/typing.css">
</head>

  
    
      <body class="dark">
    
  
      <div id="container" class="container">
        <article id="post-HTTP-2-by-Node-js" class="article article-type-post" itemscope itemprop="blogPost">
  <header id="header" class="header">
  <nav id="main-nav" class="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    
      <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
    
  </nav>
</header>

  <hr/>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      HTTP/2 by Node.js
    </h1>
  

      </header>
    
    <div class="article-entry typo" itemprop="articleBody">
      
        <p><a href="https://dexecure.com/blog/how-to-create-http2-static-file-server-nodejs-with-examples/" target="_blank" rel="external">Origin</a></p>
<p>Websites delivered using HTTP/2 enjoys a wide range of new features including -</p>
<ul>
<li><p>fully multiplexed connections: all requests and responses to a domain are fully multiplexed via a single connection, making best use of available bandwidth.</p>
</li>
<li><p>header compression: repeated headers are compressed with HPACK compression so that they are not resent with every request and response.</p>
</li>
<li><p>PUSH: resources can be pre-emptively pushed by the server to the client, speeding up page load times.</p>
</li>
</ul>
<p>Node.js just launched support(v8.8.1) for HTTP/2 as part of their core. In this post, we will create a simple HTTP/2 server to serve static files and then demonstrate some cool features like HTTP/2 PUSH.</p>
<h3 id="Get-an-SSL-certificate"><a href="#Get-an-SSL-certificate" class="headerlink" title="Get an SSL certificate"></a>Get an SSL certificate</h3><p>Even though the HTTP/2 spec does not mandate HTTPS, browsers have decided that they will only support HTTP/2 on a HTTPS connection. This would also mitigate interference from older proxies which may not understand newer protocol.</p>
<p>For your local server, a self-signed certificate will work. You can find how to setup a self-signed certificate <a href="https://www.digitalocean.com/community/tutorials/how-to-create-a-self-signed-ssl-certificate-for-nginx-in-ubuntu-16-04" target="_blank" rel="external">here</a></p>
<h3 id="Building-a-Static-File-Server"><a href="#Building-a-Static-File-Server" class="headerlink" title="Building a Static File Server"></a>Building a Static File Server</h3><p>Let us start with a simple server which just serves static files. Note that if you are using node.js 8.7.0, you need to run node with the <code>--expose-http2</code> flag.</p>
<p>We will be listening to the <code>stream</code> event and responding to it with the corresponding file from the server root(public, in this case) using the <code>respondWithFile</code> API. We are using the <code>mime-type</code> module to look up the correct mime type to send along with the response.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> http2 = <span class="built_in">require</span>(<span class="string">'http2'</span>)</div><div class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</div><div class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</div><div class="line"><span class="keyword">const</span> mime = <span class="built_in">require</span>(<span class="string">'mime-types'</span>)</div><div class="line"></div><div class="line">cosnt &#123;</div><div class="line">  HTTP2_HEADER_PATH,</div><div class="line">  HTTP2_HEADER_METHOD,</div><div class="line">  HTTP_STATUS_NOT_FOUND,</div><div class="line">  HTTP_STATUS_INTERNAL_SERVER_ERROR</div><div class="line">&#125; = http2.constants</div><div class="line"></div><div class="line"><span class="keyword">const</span> options = &#123;</div><div class="line">  <span class="attr">key</span>: fs.readFileSync(<span class="string">'./selfsigned.key'</span>),</div><div class="line">  <span class="attr">cert</span>: fs.readFileSync(<span class="string">'./selfsigned.crt'</span>),</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> server = http2.createSecureServer(options)</div><div class="line"></div><div class="line"><span class="keyword">const</span> serverRoot = <span class="string">'./public'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">respondToStreamError</span>(<span class="params">err, stream</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(err)</div><div class="line">  <span class="keyword">if</span> (err.code === <span class="string">'ENOENT'</span>) &#123;</div><div class="line">    stream.respond(&#123;</div><div class="line">      <span class="string">':stats'</span>: HTTPS_STATUS_NOT_FOUND,</div><div class="line">    &#125;)</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    stream.respond(&#123;</div><div class="line">      <span class="string">':status'</span>: HTTP_STATUS_INTERNAL_SERVER_ERROR,</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line">  stream.end()</div><div class="line">&#125;</div><div class="line"></div><div class="line">server.on(<span class="string">'stream'</span>, (stream, headers) =&gt; &#123;</div><div class="line">  <span class="keyword">const</span> reqPath = headers[HTTP2_HEADER_PATH]</div><div class="line">  <span class="keyword">const</span> reqMethod = headers[HTTP2_METHOD]</div><div class="line"></div><div class="line">  <span class="keyword">const</span> fullPath = path.join(serverRoot, reqPath)</div><div class="line">  <span class="keyword">const</span> responseMimeType = mime.lookup(fullPath)</div><div class="line"></div><div class="line">  stream.respondWithFile(fullPath, &#123;</div><div class="line">    <span class="string">'content-type'</span>: responseMimeType</div><div class="line">  &#125;, &#123;</div><div class="line">    <span class="attr">onError</span>: <span class="function"><span class="params">err</span> =&gt;</span> respondToStreamError(err, stream)</div><div class="line">  &#125;)</div><div class="line">&#125;)</div><div class="line"></div><div class="line">server.listen(<span class="number">443</span>)</div></pre></td></tr></table></figure>
<h3 id="Server-PUSH-Example"><a href="#Server-PUSH-Example" class="headerlink" title="Server PUSH Example"></a>Server PUSH Example</h3><p>Now we have simpel HTTP/2 server running, lets try to use one of the new featues in HTTP/2 - HTTP/2 PUSH. This can lead to significant performance improvements in high latency environments, if done correctly.</p>
<p>We are loading a simple HTML file pointing to style.css which references to our font file. The request to the font file is only made after css file is discovered in the HTML, downloaded and then parsed. This is how the waterfall would have usually looked like:</p>
<p><img src="https://dexecure.com//images/blog/waterfall-without-http2.53b722f2.png" alt=""></p>
<p>You can initate a new PUSH with the <code>pushStream</code> API. Since we know that the browser is going to be requesting the font file in the future, we can PUSH the font file as soon as the server receives the request for the HTML file.</p>
<p>When the actual request for the font file takes place, it is claimed from the PUSH cache, instead of making a network request then.</p>
<p><img src="https://dexecure.com//images/blog/waterfall-with-http2.b47218ea.png" alt=""></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> http2 = <span class="built_in">require</span>(<span class="string">'http2'</span>)</div><div class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</div><div class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</div><div class="line"><span class="keyword">const</span> mime = <span class="built_in">require</span>(<span class="string">'mime-types'</span>)</div><div class="line"></div><div class="line"><span class="keyword">const</span> &#123;</div><div class="line">  HTTP2_HEADER_PATH,</div><div class="line">  HTTP2_HEADER_METHOD,</div><div class="line">  HTTP_STATUS_NOT_FOUND,</div><div class="line">  HTTP_STATUS_INTERNAL_SERVER_ERROR,</div><div class="line">&#125; = http2.constants</div><div class="line"></div><div class="line"><span class="keyword">const</span> options = &#123;</div><div class="line">  <span class="attr">key</span>: fs.readFileSync(<span class="string">'./selfsigned.key'</span>),</div><div class="line">  <span class="attr">cert</span>: fs.readFileSync(<span class="string">'./selfsigned.crt'</span>),</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> server = http2.createSecureServer(options)</div><div class="line"></div><div class="line"><span class="keyword">const</span> serverRoot = <span class="string">'./public'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">respondToStreamError</span> (<span class="params">err, stream</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(err)</div><div class="line">  <span class="keyword">if</span> (err.code === <span class="string">'ENOENT'</span>) &#123;</div><div class="line">    stream.respond(&#123;</div><div class="line">      <span class="string">':status'</span>: HTTP_STATUS_NOT_FOUND,</div><div class="line">    &#125;)</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    stream.respond(&#123;</div><div class="line">      <span class="string">':status'</span>: HTTP_STATUS_INTERNAL_SERVER_ERROR,</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line">  stream.end()</div><div class="line">&#125;</div><div class="line"></div><div class="line">server.on(<span class="string">'stream'</span>, (stream, headers) =&gt; &#123;</div><div class="line">  <span class="keyword">const</span> reqPath = headers[HTTP2_HEADER_PATH]</div><div class="line">  <span class="keyword">const</span> reqMethod = headers[HTTP2_HEADER_METHOD]</div><div class="line">  <span class="keyword">const</span> fullPath = path.join(serverRoot, reqPath)</div><div class="line">  <span class="keyword">const</span> responseMimeType = mime.lookup(fullPath)</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (fullPath.endsWith(<span class="string">'.html'</span>)) &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'html'</span>)</div><div class="line">    <span class="comment">// handle the html file</span></div><div class="line">    stream.respondWithFile(fullPath, &#123;</div><div class="line">      <span class="string">'content-type'</span>: <span class="string">'text/html'</span></div><div class="line">    &#125;, &#123;</div><div class="line">      <span class="attr">onError</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</div><div class="line">        respondToStreamError(err, stream)</div><div class="line">      &#125;</div><div class="line">    &#125;)</div><div class="line"></div><div class="line">    stream.pushStream(&#123;</div><div class="line">      <span class="string">':path'</span>: <span class="string">'/font.woff'</span></div><div class="line">    &#125;, &#123;</div><div class="line">      <span class="attr">parent</span>: stream.id,</div><div class="line">    &#125;, pushStream =&gt; &#123;</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">'pushing'</span>)</div><div class="line">      pushStream.respondWithFile(path.join(serverRoot, <span class="string">'/font.woff'</span>), &#123;</div><div class="line">        <span class="string">'content-type'</span>: <span class="string">'text/css'</span>,</div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="attr">onError</span>: <span class="function"><span class="params">err</span> =&gt;</span> &#123;</div><div class="line">          respondToStreamError(err, pushStream)</div><div class="line">        &#125;</div><div class="line">      &#125;)</div><div class="line">    &#125;)</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// handle the static file</span></div><div class="line">    <span class="built_in">console</span>.log(fullPath)</div><div class="line">    stream.respondWithFile(fullPath, &#123;</div><div class="line">      <span class="string">'content-type'</span>: responseMimeType,</div><div class="line">    &#125;, &#123;</div><div class="line">      <span class="attr">onError</span>: <span class="function"><span class="params">err</span> =&gt;</span> respondToStreamError(err, stream)</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line">&#125;)</div><div class="line"></div><div class="line">server.listen(<span class="number">443</span>)</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <ul class="article-meta">
        <li>
          <span class="label">Published Date:</span>
          <a href="/2017/11/07/HTTP-2-by-Node-js/" class="article-date">
  <time datetime="2017-11-07T01:43:53.000Z" itemprop="datePublished">2017-11-07</time>
</a>

        </li>
        
        
          <li>
            <span class="label">Tag:</span>
            
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HTTP2-Node/">HTTP2, Node</a></li></ul>


          </li>
        
        <hr/>
      </ul>
    </footer>
  </div>
  
    
<nav id="article-nav" class="article-nav">
  
    <span id="article-nav-newer" class="article-nav-link-wrap newer"></span>
  
  
    <a href="/2017/11/06/Rocket-of-Rust/" id="article-nav-older" class="article-nav-link-wrap older">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Rocket of Rust</div>
    </a>
  
</nav>


  
</article>




      </div>
      
    <footer id="footer" class="post-footer footer">
      <hr/>
      <div id="footerContent" class="footer-content">
        <p>Write for Archive</p>


      </div>
    </footer>

      

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/typing.js"></script>
<!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->







    </div>
  </body>
</html>
